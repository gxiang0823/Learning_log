### 查看线程和进程
在 Linux 系统中，查看多进程和多线程程序的核心工具围绕 **`ps`、`top`、`pstree`、`htop`** 等，其中多线程的查看需要针对 Linux 中“线程=轻量级进程（LWP）”的特性，使用特定参数过滤。以下是分场景的详细方法，包含命令、参数解释和实战示例：


#### 一、查看多进程程序
进程是操作系统资源分配的基本单位，每个进程有独立的 PID（进程 ID）。核心工具是 `ps`（静态查看）、`top`（实时监控）、`pstree`（树状层级）。

1.  静态查看所有进程（`ps` 命令）
`ps` 是最基础的进程查看工具，常用参数组合可覆盖绝大多数场景：
```bash
# 1. 查看系统所有进程（全格式、包含命令行）
ps aux

# 2. 查看进程的父-child 关系（PPID=父进程ID，PID=子进程ID）
ps -ef

# 3. 过滤特定程序的进程（例如查看 Python 程序的所有进程）
ps aux | grep python
ps -ef | grep java
```
2.  输出字段关键含义：

| 字段       | 说明                          |
|------------|-----------------------------|
| `PID`      | 进程唯一 ID（核心标识）       |
| `PPID`     | 父进程 ID（查看进程层级用）    |
| `%CPU`     | 进程占用的 CPU 百分比         |
| `%MEM`     | 进程占用的内存百分比          |
| `USER`     | 进程所属用户                 |
| `COMMAND`  | 启动进程的命令（含参数）      |

-   示例：查看 Nginx 多进程（Nginx 默认是多进程模型）
    ```bash
    ps aux | grep nginx
    ```
    输出可能如下（`nginx: master process` 是主进程，`nginx: worker process` 是工作进程，即多进程）：
    ```
    root      1234  0.0  0.1  12340  2340 ?        Ss   10:00   0:00 nginx: master process /usr/sbin/nginx
    www-data  1235  0.2  0.3  12560  4560 ?        S    10:00   0:05 nginx: worker process
    www-data  1236  0.1  0.3  12560  4520 ?        S    10:00   0:03 nginx: worker process
    ```


3.  实时监控进程（`top` 命令）
`top` 是实时交互工具，默认每 3 秒刷新一次，适合观察进程资源占用变化：
```bash
# 启动实时监控
top

# 关键交互快捷键（启动后按）
P：按 CPU 使用率排序（默认）
M：按内存使用率排序
N：按 PID 排序
u：过滤指定用户的进程（例如输入 root 只看 root 进程）
p：过滤指定 PID 的进程（例如输入 1234 只看 PID=1234 的进程）
q：退出 top
```
-   示例：实时观察 Python 多进程程序的 CPU/内存占用
    启动 `top` 后按 `u`，输入运行 Python 程序的用户名（如 `ubuntu`），即可只显示该用户的 Python 进程。


4.  树状查看进程层级（`pstree` 命令）
`pstree` 以树状结构展示进程的父-child 关系，适合快速查看多进程的衍生关系（例如主进程 fork 出的子进程）：
```bash
# 查看所有进程的树状结构（PID 显示在括号中）
pstree -p

# 过滤特定进程的树状结构（例如查看 PID=1234 的进程及其子进程）
pstree -p 1234

# 查看指定用户的进程树
pstree -u ubuntu
```
-   示例：查看 Nginx 进程树（主进程 + 工作进程）
    ```bash
    pstree -p | grep nginx
    ```
    输出：
    ```
    nginx(1234)───nginx(1235)
                └──nginx(1236)
    ```


#### 二、查看多线程程序
Linux 中线程被称为“轻量级进程（LWP）”，共享进程的地址空间，每个线程有独立的 LWP（线程 ID），但共享同一个 PID（进程 ID）。查看多线程的核心是：**显示进程下的所有 LWP**。

1.  用 `ps` 查看指定进程的所有线程
```bash
# 1. 查看所有线程（H：线程模式，显示每个线程为独立行）
ps auxH

# 2. 查看指定进程的所有线程（L：显示 LWP 线程ID，p：指定 PID）
ps -Lp <进程PID>

# 3. 详细显示线程信息（包含线程状态、优先级）
ps -mp <进程PID> -o PID,PPID,LWP,NLWP,PCPU,STAT,COMMAND
```
输出字段关键含义：

| 字段 | 说明 |
|-----|-----|
| `LWP` | 线程 ID（核心标识）|
| `NLWP` | 进程的总线程数 |
| `STAT` | 线程状态（R=运行，S=睡眠等）|

-   示例：查看 Python 多线程程序（PID=5678）的所有线程
    ```bash
    # 先找到 Python 程序的 PID
    ps aux | grep python  # 假设 PID=5678

    # 查看该进程的所有线程
    ps -Lp 5678
    ```
    输出（`LWP` 不同的行就是不同线程，`PID` 相同）：
    ```
    PID   LWP TTY          TIME CMD
    5678  5678 pts/0    00:00:00 python
    5678  5679 pts/0    00:00:01 python
    5678  5680 pts/0    00:00:01 python
    ```


1.  用 `top` 实时监控线程
`top` 加 `-H` 参数可进入“线程模式”，将每个线程当作独立条目显示，方便观察线程的资源占用：
```bash
# 1. 实时监控所有线程（H：线程模式）
top -H

# 2. 实时监控指定进程的所有线程（Hp：指定 PID，只看该进程的线程）
top -Hp <进程PID>
```
-   交互快捷键（同 `top`）：
    -   `P`：按线程 CPU 使用率排序（快速找到最耗 CPU 的线程）
    -   `M`：按线程内存使用率排序
    -   `q`：退出

-   示例：监控 Java 多线程程序（PID=9012）的线程
    ```bash
    top -Hp 9012
    ```
    输出中，`PID` 列实际显示的是 `LWP`（线程 ID），`COMMAND` 列显示线程所属的进程名，可快速定位高负载线程。


3.  用 `htop` 可视化查看线程（推荐）
`htop` 是 `top` 的增强版，界面更友好，支持线程的树状显示和快速切换，需手动安装（`yum install htop` 或 `apt install htop`）：
```bash
# 启动 htop
htop

# 关键快捷键
F2 → Display options → 勾选 "Tree view"（树状显示进程/线程）
F2 → Display options → 勾选 "Show threads"（显示线程）
H：切换“显示/隐藏线程”（按 H 一次显示所有线程，再按一次隐藏）
P：按 CPU 排序，M：按内存排序
```
-   优势：
    -   线程以缩进形式显示在父进程下（树状结构），一目了然
    -   支持鼠标操作，可直接点击进程展开/折叠线程
    -   显示线程数（`THR` 列），快速判断进程是否为多线程


4.  从 `/proc` 文件系统查看线程（底层方式）
Linux 每个进程的信息都存储在 `/proc/<PID>` 目录下，线程对应的目录是 `/proc/<PID>/task/<LWP>`（每个 LWP 对应一个子目录）：
```bash
# 1. 查看指定进程的总线程数
cat /proc/<进程PID>/status | grep Threads

# 2. 查看指定进程的所有线程 ID（LWP）
ls /proc/<进程PID>/task/

# 3. 查看某个线程的详细信息（例如 LWP=5679）
cat /proc/<进程PID>/task/<LWP>/status
```
-   示例：查看 PID=5678 的进程的线程数和线程 ID
    ```bash
    # 总线程数
    cat /proc/5678/status | grep Threads
    # 输出：Threads:	3（表示 3 个线程）

    # 所有线程 ID（LWP）
    ls /proc/5678/task/
    # 输出：5678  5679  5680（3 个线程的 LWP）
    ```


#### 三、关键区别：多进程 vs 多线程的查看特征
| 维度 | 多进程程序 | 多线程程序 |
|-----|-----|-----|
| PID | 每个进程有独立 PID | 所有线程共享同一个 PID |
| LWP | 每个进程的 LWP = 自身 PID | 每个线程有独立 LWP（≠ PID）|
| `ps` 查看 | `ps aux` 显示多个独立 PID | `ps -Lp <PID>` 显示多个 LWP |
| `top` 查看 | 多个独立条目（不同 PID）| `top -Hp <PID>` 显示多个条目（不同 LWP）|
| `/proc` 目录 | 每个进程对应 `/proc/<PID>` | 所有线程对应 `/proc/<PID>/task/<LWP>` |


#### 四、常用场景总结
| 需求 | 推荐命令 |
|-----|-----|
| 快速查看系统所有多进程 | `ps aux` 或 `top` |
| 查看进程的父子关系 | `pstree -p` 或 `ps -ef` |
| 查看指定程序的所有线程 | `ps -Lp <PID>` 或 `htop`（按 H 显示线程）|
| 实时监控线程的 CPU/内存占用 | `top -Hp <PID>` 或 `htop` |
| 验证进程是否为多线程 | `cat /proc/<PID>/status | grep Threads` |
| 可视化查看线程结构 | `htop`（树状模式）|